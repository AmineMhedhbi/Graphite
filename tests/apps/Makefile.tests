# This makefile is included by all the tests to contain
# default rules.

SIM_ROOT ?= $(CURDIR)/../../../

CLEAN=$(findstring clean,$(MAKECMDGOALS))
ifeq ($(CLEAN),)
include $(SIM_ROOT)/common/Makefile.common
endif

all: $(BUILD_TARGET)

CXXFLAGS = -I$(SIM_ROOT)/common/user -I$(SIM_ROOT)/common/misc -c -g -Wall 

LDFLAGS += -lm

CFLAGS = $(CXXFLAGS) -std=c99

CARBON_SOURCES = $(SIM_ROOT)/tests/user/sync_api.c $(SIM_ROOT)/tests/user/capi.c $(SIM_ROOT)/tests/user/thread_support.c
CARBON_OBJECTS = $(CARBON_SOURCES:%.c=%.o)

# include the dependencies for the objects
ifneq ($(MAKECMDGOALS),clean)
include $(CARBON_OBJECTS:%.o=%.d)
endif

# These are the objects required by each test
OBJECTS = $(CPP_SOURCES:%.cc=%.o) $(C_SOURCES:%.c=%.o) 

# Build rules
$(C_SOURCES): $(CARBON_SOURCES)

$(BUILD_TARGET): $(OBJECTS) $(CARBON_OBJECTS)
	$(CXX) -pthread $(LDFLAGS) -o $@ $^

ifneq ($(CLEAN),)
clean:
	-rm -f *.d *.o $(TARGET) sim.out
endif
